<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stock Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root {
  --bg:#0b1220; --panel:#020617; --border:#1f2937; --text:#e5e7eb;
  --green:#22c55e; --red:#ef4444; --orange:#f59e0b;
}
body { margin:0; background:linear-gradient(#020617,#0b1220); color:var(--text); font-family:system-ui }
header { position:sticky; top:0; background:#020617; padding:8px; z-index:10; border-bottom:1px solid var(--border); }
.controls { display:flex; flex-wrap:wrap; gap:6px }
input,select,button { background:#0f172a; color:#fff; border:1px solid var(--border); padding:5px 7px; border-radius:7px }
.container { padding:6px }
table { width:100%; border-collapse:collapse; font-size:13px }
th,td { border:1px solid var(--border); padding:3px 4px; text-align:center; white-space:nowrap }
th { background:#020617; position:sticky; top:60px }
tr:nth-child(even) { background:#0f172a }

.green{color:var(--green);font-weight:800}
.red{color:var(--red);font-weight:800}
.orange{color:var(--orange);font-weight:800}
.bold{font-weight:900}

.stockBtn{
  background:none;border:none;cursor:pointer;
  font-weight:900;font-size:14px;
}
.popup{position:fixed;bottom:20px;right:20px;background:#020617;border:1px solid var(--border);padding:10px;border-radius:12px;display:none}

.backtest{
 position:fixed;right:10px;bottom:10px;
 background:#020617;border:1px solid #1f2937;
 padding:10px;border-radius:10px;font-size:12px;
}
</style>
</head>
<body>

<header>
  <div class="controls">
    <input type="date" id="date" />
    <button onclick="render()">Submit</button>
    <input id="search" placeholder="Search..." oninput="render()" />
    <button onclick="filter='buy';render()">Only Buy</button>
    <button onclick="filter='sell';render()">Only Sell</button>
    <button onclick="filter='all';render()">All</button>
    <select id="sort" onchange="render()">
      <option value="">Sort</option>
      <option value="volDesc">Volume â†“</option>
      <option value="volAsc">Volume â†‘</option>
      <option value="rsiDesc">RSI â†“</option>
      <option value="rsiAsc">RSI â†‘</option>
      <option value="priceDesc">Price â†“</option>
      <option value="priceAsc">Price â†‘</option>
      <option value="chgDesc">%Change â†“</option>
      <option value="chgAsc">%Change â†‘</option>
    </select>
    <input id="newStock" placeholder="Add stock" />
    <button onclick="addStock()">Add</button>
    <button onclick="muted=!muted">Mute</button>
    <button onclick="screenshot()">ðŸ“¸ Screenshot</button>
  </div>
  <div style="font-size:11px;color:#94a3b8">Last refresh: <span id="time"></span></div>
</header>

<div class="container">
<table>
<thead>
<tr>
<th>Stock</th><th>Live</th><th>SL</th><th>Target</th><th>Vol(L)</th>
<th>Today</th><th>1W</th><th>1M</th>
<th>Support</th><th>Resistance</th>
<th>RSI</th><th>EMA9</th><th>EMA21</th><th>Signal</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<div class="popup" id="popup"><div id="popupText"></div><button onclick="popup.style.display='none'">Close</button></div>

<div class="backtest">
<b>ðŸ“Š Backtester</b><br>
Trades: <span id="bt_trades">0</span><br>
Wins: <span id="bt_wins">0</span><br>
Loss: <span id="bt_loss">0</span><br>
Win Rate: <span id="bt_wr">0%</span><br>
P/L: â‚¹<span id="bt_pl">0</span><br>
Max DD: â‚¹<span id="bt_dd">0</span><br><br>
<button onclick="runBacktest()">Run Backtest</button>
</div>

<script>
const WORKER="https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const API=s=>`${WORKER}?symbol=${s}`;

const TELEGRAM_BOT = "";
const TELEGRAM_CHAT = "";

let BASE=["NIFTYBEES","TATAGOLD","TATSILV","HINDCOPPER","BSE","SAGILITY","CUPID","IDEA","BHARATCOAL","JPPOWER","HDFCBANK","SBIN","MON100","MEESHO","RVNL","ORIENTTECH","HARAFIN","RBLBANK","IRIS","GREAVESCOT","NTPCGREEN","TCS","KIMS"];
let user=JSON.parse(localStorage.getItem("stocks")||"[]");
let STOCKS=[...new Set([...BASE,...user])];

let DB={}, filter="all", muted=false, last={};

const EMA=(a,p)=>{let k=2/(p+1),e=a[0];for(let v of a)e=v*k+e*(1-k);return e}

function RSI(arr){
 let gains=0,losses=0;
 for(let i=1;i<arr.length;i++){
  let diff=arr[i]-arr[i-1];
  if(diff>=0) gains+=diff; else losses-=diff;
 }
 let rs=gains/(losses||1);
 return 100-(100/(1+rs));
}

function signal(e9,e21,r){ return e9>e21 && r>60 ? "BUY" : e9<e21 && r<40 ? "SELL" : "HOLD"; }

function parse(j){
 try{
  let r=j.chart.result[0],q=r.indicators.quote[0];
  return r.timestamp.map((t,i)=>({date:new Date(t*1000).toISOString().slice(0,10),
  open:q.open[i],high:q.high[i],low:q.low[i],close:q.close[i],volume:q.volume?.[i]||0})).filter(x=>x.close);
 }catch{return []}
}

async function load(s){ try{DB[s]=parse(await (await fetch(API(s))).json());} catch{DB[s]=[]} }

function addStock(){
 let s=newStock.value.trim().toUpperCase();
 if(s&&!STOCKS.includes(s)){STOCKS.push(s);localStorage.setItem("stocks",JSON.stringify(STOCKS));load(s);}
 newStock.value="";
}

/* ---------- BACKTESTER FIXED ---------- */
function runBacktest(){
 let trades=[];

 for(let s of STOCKS){
  let d=DB[s];
  if(!d || d.length<120) continue;

  let closes=d.map(x=>x.close);

  for(let i=30;i<d.length-5;i++){
   let slice=closes.slice(0,i+1);

   let e9=EMA(slice.slice(-9),9);
   let e21=EMA(slice.slice(-21),21);
   let r=RSI(slice.slice(-15));
   let sig=signal(e9,e21,r);
   if(sig==="HOLD") continue;

   let entry=d[i].close;
   let range=d[i].high-d[i].low;
   if(range<=0) continue;

   let sl=sig==="BUY"?entry-range*0.8:entry+range*0.8;
   let tgt=sig==="BUY"?entry+range*1.2:entry-range*1.2;

   let closed=false;

   for(let j=i+1;j<d.length;j++){
    let c=d[j];
    if(sig==="BUY"){
     if(c.low<=sl){ trades.push(-1); closed=true; break; }
     if(c.high>=tgt){ trades.push(+1.5); closed=true; break; }
    }else{
     if(c.high>=sl){ trades.push(-1); closed=true; break; }
     if(c.low<=tgt){ trades.push(+1.5); closed=true; break; }
    }
   }

   if(!closed){
    let last=d.at(-1).close;
    let pnl=sig==="BUY"?last-entry:entry-last;
    trades.push(pnl>0?0.5:-0.5);
   }
  }
 }

 let wins=trades.filter(x=>x>0).length;
 let loss=trades.filter(x=>x<=0).length;
 let total=trades.length;
 let pnl=trades.reduce((a,b)=>a+b,0);

 let eq=[0],peak=0,dd=0;
 trades.forEach(p=>{
  let v=eq.at(-1)+p;
  eq.push(v);
  peak=Math.max(peak,v);
  dd=Math.min(dd,v-peak);
 });

 bt_trades.textContent=total;
 bt_wins.textContent=wins;
 bt_loss.textContent=loss;
 bt_wr.textContent=((wins/total)*100||0).toFixed(1)+"%";
 bt_pl.textContent=pnl.toFixed(2);
 bt_dd.textContent=dd.toFixed(2);
}

/* existing */
function screenshot(){ html2canvas(document.body).then(c=>{ let d=new Date(); let name=d.getHours()+""+d.getMinutes()+"_"+d.getDate()+""+(d.getMonth()+1)+""+d.getFullYear()+"_STOCKS.png"; let a=document.createElement("a"); a.download=name; a.href=c.toDataURL(); a.click(); });}
function autoScreens(){ const times=["09:00","09:30","10:00","10:30","11:00","11:30","12:00","13:00","14:00","14:30","15:00","15:15","15:30"]; setInterval(()=>{ let now=new Date(); let t=now.toTimeString().slice(0,5); if(times.includes(t)) screenshot(); },60000);}
async function init(){for(let s of STOCKS)await load(s);render();setInterval(render,60000);autoScreens();}
init();
</script>
</body>
</html>
