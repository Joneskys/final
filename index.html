<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stock Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root {
  --bg:#0b1220; --panel:#020617; --border:#1f2937; --text:#e5e7eb;
  --green:#22c55e; --red:#ef4444; --orange:#f59e0b;
}
body { margin:0; background:linear-gradient(#020617,#0b1220); color:var(--text); font-family:system-ui }
header { position:sticky; top:0; background:#020617; padding:8px; z-index:10; border-bottom:1px solid var(--border); }
.controls { display:flex; flex-wrap:wrap; gap:6px }
input,select,button { background:#0f172a; color:#fff; border:1px solid var(--border); padding:5px 7px; border-radius:7px }
.container { padding:6px }
table { width:100%; border-collapse:collapse; font-size:13px }
th,td { border:1px solid var(--border); padding:3px 4px; text-align:center; white-space:nowrap }
th { background:#020617; position:sticky; top:60px }
tr:nth-child(even) { background:#0f172a }

.green{color:#22c55e;font-weight:800}
.red{color:#ef4444;font-weight:800}
.orange{color:#f59e0b;font-weight:800}
.bold{font-weight:900}

.stockBtn{background:none;border:none;cursor:pointer;font-weight:900;font-size:14px;}
.popup{position:fixed;bottom:20px;right:20px;background:#020617;border:1px solid #1f2937;padding:10px;border-radius:12px;display:none}

.floating{
position:fixed;right:10px;background:#020617;border:1px solid #1f2937;
padding:8px;border-radius:10px;font-size:12px;z-index:9999;max-width:260px
}
canvas{background:#020617;border:1px solid #1f2937;border-radius:8px}
</style>
</head>
<body>

<header>
  <div class="controls">
    <input type="date" id="date" />
    <button onclick="render()">Submit</button>
    <input id="search" placeholder="Search..." oninput="render()" />
    <button onclick="filter='buy';render()">Only Buy</button>
    <button onclick="filter='sell';render()">Only Sell</button>
    <button onclick="filter='all';render()">All</button>
    <select id="sort" onchange="render()">
      <option value="">Sort</option>
      <option value="volDesc">Volume â†“</option>
      <option value="volAsc">Volume â†‘</option>
      <option value="rsiDesc">RSI â†“</option>
      <option value="rsiAsc">RSI â†‘</option>
      <option value="priceDesc">Price â†“</option>
      <option value="priceAsc">Price â†‘</option>
      <option value="chgDesc">%Change â†“</option>
      <option value="chgAsc">%Change â†‘</option>
    </select>
    <input id="newStock" placeholder="Add stock" />
    <button onclick="addStock()">Add</button>
    <button onclick="muted=!muted">Mute</button>
    <button onclick="screenshot()">ðŸ“¸ Screenshot</button>
  </div>
  <div style="font-size:11px;color:#94a3b8">Last refresh: <span id="time"></span></div>
</header>

<div class="container">
<table>
<thead>
<tr>
<th>Stock</th><th>Live</th><th>SL</th><th>Target</th><th>Vol(L)</th>
<th>Today</th><th>1W</th><th>1M</th>
<th>Support</th><th>Resistance</th>
<th>RSI</th><th>EMA9</th><th>EMA21</th><th>Signal</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<div class="floating" style="top:80px">
<b>ðŸ“Š Strategy Stats</b><br>
Trades: <span id="st_trades">0</span><br>
Wins: <span id="st_wins">0</span><br>
Loss: <span id="st_loss">0</span><br>
Win Rate: <span id="st_win">0%</span>
</div>

<div class="floating" style="bottom:10px;left:10px">
<b>ðŸ“˜ Trade Journal</b>
<div id="journal" style="max-height:140px;overflow:auto"></div>
</div>

<div class="floating" style="bottom:10px;right:10px">
<b>ðŸ“ˆ P/L Curve</b><br>
<canvas id="curve" width="240" height="120"></canvas>
</div>

<script>
const WORKER="https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const API=s=>`${WORKER}?symbol=${s}`;

const TELEGRAM_BOT="8168507195:AAHXFWjfWqDZ4A4ZWnBIIsoc9wu2yp6uGmU";
const TELEGRAM_CHAT="1652821502";

let BASE=["SBIN","IDEA","RVNL","TCS"];
let STOCKS=[...BASE];

let DB={}, last={}, journal=[], equity=[0];

const EMA=(a,p)=>{let k=2/(p+1),e=a[0];for(let v of a)e=v*k+e*(1-k);return e}
const RSI=a=>{let g=0,l=0;for(let i=1;i<=14;i++){let d=a[i]-a[i-1];d>0?g+=d:l-=d}let rs=g/(l||1);return 100-(100/(1+rs))}
function signal(e9,e21,r){return e9>e21&&r>60?"BUY":e9<e21&&r<40?"SELL":"HOLD"}

function parse(j){
 try{
  let r=j.chart.result[0],q=r.indicators.quote[0];
  return r.timestamp.map((t,i)=>({
    date:new Date(t*1000).toISOString().slice(0,10),
    open:q.open[i],high:q.high[i],low:q.low[i],close:q.close[i],volume:q.volume?.[i]||0
  })).filter(x=>x.close);
 }catch{return []}
}

async function load(s){DB[s]=parse(await (await fetch(API(s))).json())}

function backtest(stock,data){
 let trades=[];
 for(let i=30;i<data.length-1;i++){
  let slice=data.slice(0,i+1);
  let cl=slice.map(x=>x.close);
  let e9=EMA(cl.slice(-9),9),e21=EMA(cl.slice(-21),21),r=RSI(cl.slice(-15));
  let sig=signal(e9,e21,r);
  if(sig==="HOLD")continue;

  let entry=data[i+1].open;
  let range=data[i].high-data[i].low;
  let sl=sig==="BUY"?entry-range*0.8:entry+range*0.8;
  let tgt=sig==="BUY"?entry+range*1.2:entry-range*1.2;

  for(let j=i+1;j<data.length;j++){
    let c=data[j];
    if(sig==="BUY"){
      if(c.low<=sl){trades.push(entry-sl);break}
      if(c.high>=tgt){trades.push(tgt-entry);break}
    } else {
      if(c.high>=sl){trades.push(sl-entry);break}
      if(c.low<=tgt){trades.push(entry-tgt);break}
    }
  }
 }
 return trades;
}

function updateStats(trades){
 let wins=trades.filter(x=>x>0).length;
 st_trades.textContent=trades.length;
 st_wins.textContent=wins;
 st_loss.textContent=trades.length-wins;
 st_win.textContent=((wins/(trades.length||1))*100).toFixed(1)+"%";
}

function drawCurve(trades){
 let eq=[0];
 trades.forEach(p=>eq.push(eq.at(-1)+p));
 let c=curve,ctx=c.getContext("2d");
 ctx.clearRect(0,0,c.width,c.height);
 let max=Math.max(...eq),min=Math.min(...eq);
 ctx.beginPath();ctx.strokeStyle="#22c55e";
 eq.forEach((v,i)=>{
  let x=i*(c.width/(eq.length-1||1));
  let y=c.height-((v-min)/(max-min||1))*c.height;
  i?ctx.lineTo(x,y):ctx.moveTo(x,y);
 });
 ctx.stroke();
}

async function init(){
 let all=[];
 for(let s of STOCKS){
  await load(s);
  let t=backtest(s,DB[s]);
  all.push(...t);
 }
 updateStats(all);
 drawCurve(all);
}
init();
</script>
</body>
</html>
